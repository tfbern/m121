<!DOCTYPE html>
<html>
<head>
  <title>Arduino IoT Demo App</title>
  <link href="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script src="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>
<body>
  <div class="mdc-layout-grid">
    <h2>Switch Arduino Pins</h2>
    <select id="pin">
      <option value=all>all</option>
      <option value=0>Pin 0</option>
      <option value=1>Pin 1</option>
      <option value=2>Pin 2</option>
      <option value=3>Pin 3</option>
      <option value=4>Pin 4</option>
      <option value=5>Pin 5</option>
      <option value=6>Pin 6</option>
      <option value=7>Pin 7</option>
      <option value=8>Pin 0</option>
      <option value=9>Pin 9</option>
      <option value=10>Pin 10</option>
      <option value=11>Pin 11</option>
      <option value=12>Pin 12</option>
      <option value=13>Pin 13</option>
    </select>&nbsp;
    <select id="state">
      <option value=0>low</option>
      <option value=1>high</option>
    </select>&nbsp;
    <input type="button" value="send" onclick="sendCommand()">
    <div id="container" style="width: 90%;">
      <h2>Temperatur</h2>
      <canvas id="myChart3"></canvas>
    </div>
    <div id="container" style="width: 90%;">
      <br>
      <h2>Analogue Inputs</h2>
      <canvas id="myChart1"></canvas>
    </div>
    <div id="container" style="width: 90%;">
      <br>
      <h2>Digital Inputs</h2>
      <canvas id="myChart2"></canvas>
    </div>
  </div>
</body>

<script>
function sendCommand(){
  var pin = document.getElementById('pin').value
  var state = document.getElementById('state').value
  var command = '';
  if (pin == 'all') {
    for (i=0; i <= 13; i++) {
      command+= i + "=" + state
      command+= ( i == 13 ) ? '' : '&'
    }
  } else {
    command = pin + "=" + state
  }
  console.log(command)
  ws.send(command)
}
function createChart(ctx, type, label)  {
  var chart = new Chart(ctx, {
      // The type of chart we want to create
      type: type,
      // The data for our dataset
      data: {
          labels: [],
          datasets: [{
              label: label,
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: []
          }]
      },
  });
  return chart
}
function updateChart(chart, xValues, yValues) {
  if (xValues && yValues) {
    chart.data.labels = xValues
    chart.data.datasets[0].data = yValues
    chart.update();
  }
} 

var ctx1 = document.getElementById('myChart1').getContext('2d');
var ctx2 = document.getElementById('myChart2').getContext('2d');
var ctx3 = document.getElementById('myChart3').getContext('2d');

var chart1 = createChart(ctx1, 'bar', 'Analog Inputs')
chart1.options.scales.yAxes[0].ticks.min = 0
chart1.options.scales.yAxes[0].ticks.max = 1024
chart1.options.scales.yAxes[0].ticks.stepSize = 128

var chart2 = createChart(ctx2, 'horizontalBar', 'Digital Inputs')
chart2.options.scales.xAxes[0].ticks.min = 0
chart2.options.scales.xAxes[0].ticks.max = 1
chart2.options.scales.xAxes[0].ticks.stepSize = 1

var chart3 = createChart(ctx3, 'line', 'Temperatursensor an A0')
chart3.options.scales.yAxes[0].ticks.suggestedMin = -50
chart3.options.scales.yAxes[0].ticks.suggestedMax = 150
chart3.data.datasets[0].fill = false

const ws = new WebSocket('ws://localhost:81/');
ws.onopen = function() {
    console.log('WebSocket Client Connected');
};

// handle messages from server
var temperatures = []
var timestamps = []
ws.onmessage = function(e) {
  try {
      var ioStates = JSON.parse(e.data)
      // console.log(ioStates);

      var keys = Object.keys(ioStates)
      var values = Object.values(ioStates)
      updateChart(chart1, keys.slice(14,20), values.slice(14,20))

      updateChart(chart2, keys.slice(0,14).reverse(), values.slice(0,14).reverse())
 
      temperatures.push(ioStates.A0/1023*5*100 - 50)
      timestamps.push(new Date().toISOString().slice(0,19).replace("T"," "))
      updateChart(chart3, timestamps, temperatures)
  } catch(err) {
      console.log('parse error: skipping malformed data')
      // console.log(err); // error in the above string (in this case, yes)!
  }
};
</script>
</html>